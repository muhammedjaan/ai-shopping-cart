<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SmartCart Ultimate</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
  <style>
    body { font-family: sans-serif; margin: 0; background: #222; color: white; display: flex; flex-direction: column; height: 100vh; }
    
    /* CAMERA CONTAINER */
    #scanner-container { position: relative; width: 100%; height: 50vh; overflow: hidden; background: black; }
    #scanner-container video { width: 100%; height: 100%; object-fit: cover; }
    #scanner-container canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
    
    /* OVERLAY LINE */
    .scan-line {
      position: absolute; top: 50%; left: 10%; width: 80%; height: 2px;
      background: red; box-shadow: 0 0 4px red; z-index: 10;
      animation: scan 2s infinite;
    }
    @keyframes scan { 0% {top: 20%} 50% {top: 80%} 100% {top: 20%} }

    /* CART UI */
    .ui-section { flex: 1; background: white; color: black; padding: 20px; border-radius: 20px 20px 0 0; display: flex; flex-direction: column; }
    .status-log { font-size: 12px; color: #555; text-align: center; margin-bottom: 10px; font-family: monospace; }
    ul { list-style: none; padding: 0; flex: 1; overflow-y: auto; }
    li { display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid #eee; }
    .total-box { font-size: 1.5rem; font-weight: bold; text-align: center; margin-top: 10px; border-top: 2px solid black; padding-top: 10px; }
    button { width: 100%; padding: 15px; background: #28a745; color: white; border: none; font-size: 1.2rem; margin-top: 10px; border-radius: 8px; }
  </style>
</head>
<body>

  <div id="scanner-container">
    <div class="scan-line"></div>
    <div id="interactive" class="viewport"></div>
  </div>

  <div class="ui-section">
    <div id="debug-log" class="status-log">Initializing Camera...</div>
    
    <ul id="cart-list">
      </ul>

    <div class="total-box">Total: $<span id="total-price">0.00</span></div>
    <button onclick="checkout()">Checkout</button>
  </div>

<script>
  // --- DATABASE ---
  const products = {
    "6294011607141": { name: "Lulu Yogurt", price: 2.50 },
    "1234567890123": { name: "Test Item", price: 1.00 }
  };

  let total = 0;
  let cart = [];
  let lastScannedCode = null;
  let lastScannedTime = 0;

  // --- LOGGER ---
  function log(msg) {
    document.getElementById("debug-log").innerText = msg;
    console.log(msg);
  }

  // --- INITIALIZATION ---
  Quagga.init({
    inputStream: {
      name: "Live",
      type: "LiveStream",
      target: document.querySelector('#interactive'),
      constraints: {
        facingMode: "environment",
        width: { min: 640, ideal: 1920 }, // Force High Res
        height: { min: 480, ideal: 1080 },
        aspectRatio: { min: 1, max: 2 }
      }
    },
    locator: {
      patchSize: "medium", // Try "large" if this fails
      halfSample: false // Don't shrink the image
    },
    numOfWorkers: 2,
    decoder: {
      readers: ["ean_reader", "code_128_reader", "upc_reader"]
    },
    locate: true
  }, function(err) {
    if (err) {
      log("Error: " + err.name + " - " + err.message);
      return;
    }
    log("Camera Ready. Scan now.");
    Quagga.start();
  });

  // --- VISUAL DEBUGGING (GREEN BOXES) ---
  Quagga.onProcessed(function(result) {
    var drawingCtx = Quagga.canvas.ctx.overlay,
        drawingCanvas = Quagga.canvas.dom.overlay;

    if (result) {
      // Clear previous boxes
      if (drawingCanvas) {
        drawingCtx.clearRect(0, 0, parseInt(drawingCanvas.getAttribute("width")), parseInt(drawingCanvas.getAttribute("height")));
        
        // Draw green boxes around detected shapes
        if (result.boxes) {
          result.boxes.filter(function (box) {
            return box !== result.box;
          }).forEach(function (box) {
            Quagga.ImageDebug.drawPath(box, {
